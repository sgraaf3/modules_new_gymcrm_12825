<div class="main-container bg-gray-800">
    <h1 class="text-blue-400">HRV Data Analysis & Report Builder</h1>

    <details id="dataManagementDetails" class="window-section" open>
        <summary class="section-summary-button bg-blue-600 hover:bg-blue-700">Data Management</summary>
        <div class="section-content p-6">
            <div class="form-group mb-4">
                <label for="dataFile" class="block text-gray-300 text-sm font-bold mb-2">Upload RR Interval Data (.csv, .txt):</label>
                <input type="file" id="dataFile" accept=".csv, .txt" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-700 text-gray-200 border-gray-600">
            </div>
            <p id="initialMessage" class="text-gray-400 mt-2">Upload a file to begin analysis and manage data points.</p>
            <p id="errorMessage" class="error-message text-red-400 hidden"></p>

            <h3 class="font-bold text-lg text-gray-100 mt-6 mb-3">All RR Intervals (Click to Exclude/Include)</h3>
            <button id="resetExclusionsBtn" class="bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700 transition-colors mb-4">
                Reset All Exclusions
            </button>
            <div id="rrDataListContainer" class="flex flex-wrap gap-2 max-h-60 overflow-y-auto bg-gray-700 p-3 rounded-md border border-gray-600">
                <p class="text-gray-400 text-sm italic">No data loaded yet. Upload a file above.</p>
            </div>

            <h3 class="font-bold text-lg text-gray-100 mt-6 mb-3">Load from Measurement History:</h3>
            <div class="form-group mb-4">
                <label for="historicalSessionSelect" class="block text-gray-300 text-sm font-bold mb-2">Select a past measurement:</label>
                <select id="historicalSessionSelect" class="p-2 rounded-md bg-gray-700 border border-gray-600 text-gray-200">
                    <option value="">-- Loading History --</option>
                </select>
            </div>
        </div>
    </details>

    <details id="printSettingsDetails" class="window-section mt-8" open>
        <summary class="section-summary-button bg-green-600 hover:bg-green-700">Report Settings</summary>
        <div class="section-content p-6">
            <h3 class="font-bold text-lg text-gray-100 mb-3">Loaded RR Interval Data</h3>
            <div id="rrDataDisplay" class="text-gray-200 bg-gray-700 p-3 rounded-md max-h-40 overflow-y-auto mb-4 border border-gray-600">
                No RR data loaded. Please upload a file in the "Data Management" section.
            </div>
            <p id="dataMessage" class="text-sm text-gray-400 mt-2">This data will be used for all analyses.</p>

            <h3 class="font-bold text-lg text-gray-100 mt-6 mb-3">Print Settings</h3>
            <div id="printSettingsList" class="space-y-3">
                <div class="setting-item flex justify-between items-center pb-2 border-b border-gray-700">
                    <span class="setting-label text-gray-300">Include Raw Data:</span>
                    <span class="setting-value text-gray-200">Yes (Default)</span>
                </div>
                <div class="setting-item flex justify-between items-center pb-2 border-b border-gray-700">
                    <span class="setting-label text-gray-300">Page Orientation:</span>
                    <select id="pageOrientation" class="p-1 border rounded-md bg-gray-700 text-gray-200 border-gray-600">
                        <option value="portrait">Portrait</option>
                        <option value="landscape">Landscape</option>
                    </select>
                </div>
                <div class="setting-item flex justify-between items-center pb-2 border-b border-gray-700">
                    <span class="setting-label text-gray-300">Font Size:</span>
                    <span class="setting-value text-gray-200">Medium (Default)</span>
                </div>
                <div class="setting-item flex justify-between items-center">
                    <span class="setting-label text-gray-300">Header/Footer:</span>
                    <span class="setting-value text-gray-200">Enabled (Default)</span>
                </div>
                <p class="text-gray-500 text-sm mt-4">More print settings will be added here in the future.</p>
            </div>
        </div>
    </details>

    <!-- The content of analysisBuilderDetails will be loaded dynamically into this div -->
    <div id="reportsBuilderContentPlaceholder"></div>

</div>

<style>
    /* Add specific styles for this view */
    body {
        font-family: 'Inter', sans-serif;
        background-color: #111827; /* Dark background */
        color: #e5e7eb;
    }
    .main-container {
        padding: 2.5rem;
        border-radius: 1rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        width: 100%;
        max-width: 1000px; /* Adjusted max-width for overall layout */
        margin: 2rem auto;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    h1 {
        color: #60a5fa; /* Blue-400 */
        text-align: center;
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 2rem;
    }
    .window-section {
        background-color: #1f2937; /* Gray-800 */
        border-radius: 0.75rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }
    .section-summary-button {
        display: block;
        width: 100%;
        padding: 1.5rem 2rem;
        color: #fff;
        font-size: 1.5rem;
        font-weight: 700;
        text-align: left;
        cursor: pointer;
        border: none;
        outline: none;
        transition: background-color .3s ease, transform .1s ease;
        position: relative;
        border-radius: .75rem .75rem 0 0;
    }
    /* Added hover state for summary buttons */
    .section-summary-button.bg-blue-600:hover { background-color: #2563eb; } /* blue-700 */
    .section-summary-button.bg-green-600:hover { background-color: #059669; } /* green-700 */
    .section-summary-button.bg-indigo-600:hover { background-color: #4f46e5; } /* indigo-700 */

    .section-summary-button::after {
        content:'â–¼';
        position:absolute;
        right:1.5rem;
        top:50%;
        transform:translateY(-50%) rotate(0);
        transition:transform .2s ease;
        font-size:1rem;
    }
    .window-section[open] > .section-summary-button::after{transform:translateY(-50%) rotate(180deg);}
    .section-content {
        padding: 1.5rem;
        background-color: #111827; /* Gray-900 */
        border-top: 1px solid #374151; /* Gray-700 */
        border-radius: 0 0 0.75rem 0.75rem;
    }
    .form-group label {
        color: #9ca3af; /* Gray-400 */
    }
    .add-analysis-options button {
        transition: background-color 0.2s ease;
    }
    .add-analysis-options button.added {
        background-color: #a78bfa; /* Light indigo when added */
        cursor: default;
        opacity: 0.7;
    }
    /* Styles for the A4 report pages */
    .report-page {
        width: 210mm; /* A4 Portrait Width */
        min-height: 297mm; /* A4 Portrait Height */
        margin: 1rem auto; /* Center pages with some margin */
        box-sizing: border-box;
        page-break-after: always; /* Force new page for each report-page div */
        position: relative; /* For absolutely positioned elements like remove button */
        /* Default hidden, will be shown by JS for active page or by print CSS */
        display: none;
        transition: all 0.3s ease-in-out; /* Smooth transition for page changes */
        transform: scale(0.95); /* Slightly shrink inactive pages */
        opacity: 0.7; /* Dim inactive pages */
    }
    .report-page.active {
        display: flex; /* Only active page is displayed */
        transform: scale(1); /* Full size for active page */
        opacity: 1; /* Full opacity for active page */
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5); /* Stronger shadow for active page */
    }
    /* Landscape view for A4 pages */
    .main-container.landscape-view .report-page {
        width: 297mm; /* A4 Landscape Width */
        min-height: 210mm; /* A4 Landscape Height */
    }

    .analysis-box {
        background-color: #1f2937; /* Gray-800 */
        border-radius: 0.75rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        cursor: grab;
        transition: transform 0.2s ease-in-out;
        border: 1px solid #374151; /* Gray-700 */
        width: 100%; /* Take full width of the report page */
    }
    .analysis-box.dragging {
        opacity: 0.5;
        border: 2px dashed #60a5fa; /* Blue-400 */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        cursor: grabbing;
    }
    .analysis-box h3 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #e5e7eb; /* Gray-200 */
        margin-bottom: 0.5rem;
        border-bottom: 1px solid #374151;
        padding-bottom: 0.5rem;
    }
    .analysis-options-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
    }
    .analysis-options-buttons button {
        background-color: #4b5563; /* Gray-600 */
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s ease;
        flex-grow: 1;
    }
    .analysis-options-buttons button:hover {
        background-color: #374151; /* Gray-700 */
    }
    .analysis-options-buttons button.active {
        background-color: #2d3748; /* Gray-800 */
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }
    .analysis-content-display {
        min-height: 250px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        background-color: #111827; /* Gray-900 */
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #374151;
        overflow: auto;
    }
    .analysis-content-display canvas {
        max-width: 100%;
        height: auto;
    }
    .analysis-content-display table {
        width: 100%;
        border-collapse: collapse;
    }
    .analysis-content-display th, .analysis-content-display td {
        padding: 0.5rem;
        border: 1px solid #374151;
        text-align: left;
        color: #e5e7eb;
    }
    .analysis-content-display th {
        background-color: #1f2937; /* Gray-800 */
        font-weight: bold;
    }
    .analysis-content-display .editable-text {
        width: 100%;
        min-height: 200px;
        border: 1px dashed #4b5563; /* Gray-600 */
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #1f2937; /* Gray-800 */
        color: #e5e7eb;
        text-align: left;
        overflow-y: auto;
        resize: vertical;
    }
    .analysis-content-display .editable-text:focus {
        outline: none;
        border-color: #60a5fa; /* Blue-400 */
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
    }
    .remove-analysis-button {
        background-color: #ef4444; /* Red-500 */
        color: white;
        padding: 0.4rem 0.8rem;
        border-radius: 0.375rem;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        margin-left: auto;
    }
    .remove-analysis-button:hover {
        background-color: #dc2626; /* Red-600 */
    }
    .remove-page-button {
        background-color: #ef4444; /* Red-500 */
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 50%;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background-color 0.2s ease;
        line-height: 1; /* Adjust line height to center 'x' */
    }
    .remove-page-button:hover {
        background-color: #dc2626; /* Red-600 */
    }

    /* Styles for rr-item in data list */
    .rr-item {
        padding: 4px 8px;
        background-color: #374151; /* Gray-700 */
        border-radius: 4px;
        cursor: pointer;
        transition: all .2s ease-in-out;
        border: 1px solid #4b5563; /* Gray-600 */
        color: #e5e7eb;
        font-weight: 500;
        flex-shrink: 0;
    }
    .rr-item:hover {
        background-color: #4b5563; /* Gray-600 */
        transform: translateY(-1px);
    }
    .rr-item.excluded {
        background-color: #fca5a5; /* Red-300 */
        border-color: #ef4444; /* Red-500 */
        color: #7f1d1d; /* Red-900 */
        text-decoration: line-through;
        opacity: .6;
    }
    .rr-item.excluded:hover {
        background-color: #f87171; /* Red-400 */
    }

    /* Print specific styles */
    @media print {
        /* Define A4 dimensions as CSS variables */
        :root {
            --a4-width-portrait: 210mm;
            --a4-height-portrait: 297mm;
            --a4-width-landscape: 297mm;
            --a4-height-landscape: 210mm;
        }

        @page {
            size: A4 portrait; /* Default to A4 portrait */
            margin: 1cm; /* Optional: set margins for the printed page */
        }
        /* Override @page size for landscape if body has landscape-mode class */
        body.landscape-mode  {
            size: A4 landscape;
        }

        body {
            background-color: #fff;
            padding: 0;
            margin: 0;
            /* Default to portrait dimensions, overridden by landscape-mode class */
            width: var(--a4-width-portrait);
            min-height: var(--a4-height-portrait);
            box-sizing: border-box;
            color: #2d3748; /* Dark text for print */
        }
        /* Apply landscape dimensions if body has landscape-mode class */
        body.landscape-mode {
            width: var(--a4-width-landscape);
            min-height: var(--a4-height-landscape);
        }

        .main-container {
            box-shadow: none;
            max-width: none;
            width: 100%;
            padding: 0; /* Remove padding for print */
            background-color: #fff; /* White background for print */
        }
        .section-summary-button, .navigation-controls, .add-analysis-options,
        .form-group, #dataManagementDetails, #printSettingsDetails, #printBtn,
        .remove-analysis-button, .remove-page-button, .analysis-options-buttons {
            display: none !important; /* Hide UI elements when printing */
        }
        #analysisBuilderDetails {
            border: none;
            box-shadow: none;
            border-radius: 0;
            overflow: visible; /* Allow content to break out if needed for page breaks */
        }
        #analysisBuilderDetails > summary {
            display: none; /* Hide the summary for the main analysis section */
        }
        #analysisBuilderDetails > .section-content {
            padding: 0; /* Remove padding for print */
            border-top: none;
            border-radius: 0;
            background-color: #fff;
        }
        #reportsBuilderContentPlaceholder {
            padding: 0 !important; /* Ensure no extra padding from placeholder */
        }
        #reportPagesWrapper {
            border: none;
            padding: 0;
            gap: 0; /* No gap between boxes on print */
            height: auto !important; /* Allow content to define height */
            min-height: unset;
            display: block; /* Change to block for print layout */
        }
        .report-page {
            display: block; /* Make all pages visible for printing */
            box-shadow: none;
            border: 1px solid #ddd; /* Light border for printed pages */
            margin: 0; /* No margin between pages for print */
            page-break-after: always; /* Ensure each page starts on a new print page */
            padding: 1cm; /* Add print margins within the page */
            background-color: #fff;
            transform: none; /* Reset transforms for print */
            opacity: 1; /* Full opacity for print */
        }
        .report-page:last-child {
            page-break-after: auto; /* No page break after the very last page */
        }

        .analysis-box {
            box-shadow: none;
            border: 1px solid #ddd;
            margin-bottom: 1rem;
            page-break-inside: avoid; /* Keep analysis box content on one page if possible */
            position: relative; /* Ensure they render normally */
            opacity: 1; /* Make all visible for print */
            pointer-events: auto;
            transform: none;
            padding: 0.5rem; /* Adjust padding for print */
            flex-shrink: unset;
            background-color: #fff;
        }
        .analysis-box:last-child {
            margin-bottom: 0;
        }
        .analysis-content-display {
            min-height: unset;
            border: none;
            padding: 0;
            background-color: transparent;
            display: block; /* Change to block for print layout */
        }
        .analysis-content-display canvas {
            width: 100% !important;
            height: auto !important;
            display: block; /* Ensure canvas is a block element for print */
            margin: 0 auto;
        }
        .analysis-content-display table {
            width: 100%;
            font-size: 0.9em;
            color: #2d3748;
        }
        .analysis-content-display th, .analysis-content-display td {
            padding: 0.3em;
            border: 1px solid #e2e8f0;
            background-color: #f0f4f8; /* Light gray for table headers */
        }
        .analysis-content-display th {
            background-color: #edf2f7;
            color: #4a5568;
        }
        .analysis-content-display .editable-text {
            border: none;
            background-color: transparent;
            resize: none;
            min-height: unset;
            font-size: 0.9em;
            color: #2d3748;
        }
        h1, h2, h3 {
            page-break-after: avoid;
            color: #1a202c; /* Darker titles for print */
        }
    }
</style>
